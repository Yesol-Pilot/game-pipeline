name: ê²Œì„ íŒŒì´í”„ë¼ì¸ CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      template_type:
        description: 'ê²Œì„ í…œí”Œë¦¿ ìœ í˜•'
        required: true
        default: 'runner'
        type: choice
        options:
          - runner
          - puzzle
          - clicker
          - match3
          - rhythm
          - idle

env:
  GODOT_VERSION: "4.2"

jobs:
  # 1. ì½”ë“œ ê²€ì¦
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install -r requirements.txt
          pip install pylint black
      
      - name: ì½”ë“œ í¬ë§· ê²€ì‚¬
        run: black --check core/
      
      - name: ë¦°íŠ¸ ê²€ì‚¬
        run: pylint core/ --disable=C,R
  
  # 2. í…ŒìŠ¤íŠ¸
  test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install -r requirements.txt
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: python test_pipeline.py
  
  # 3. Godot ë¹Œë“œ (ìˆ˜ë™ íŠ¸ë¦¬ê±° ì‹œ)
  build:
    needs: test
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Godot ì„¤ì¹˜
        uses: chickensoft-games/setup-godot@v1
        with:
          version: ${{ env.GODOT_VERSION }}
      
      - name: í…œí”Œë¦¿ ë³µì‚¬
        run: |
          TEMPLATE_DIR="templates/template_${{ inputs.template_type }}"
          BUILD_DIR="build_output"
          mkdir -p $BUILD_DIR
          cp -r $TEMPLATE_DIR/* $BUILD_DIR/
      
      - name: ì—ì…‹ ì„í¬íŠ¸
        run: |
          cd build_output
          godot --headless --editor --quit || true
      
      - name: HTML5 ë¹Œë“œ
        run: |
          cd build_output
          mkdir -p export
          godot --headless --export-release "Web" export/index.html || echo "ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” í”„ë¦¬ì…‹ ë¯¸ì„¤ì •"
      
      - name: ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: game-build-${{ inputs.template_type }}
          path: build_output/export/
          retention-days: 7
  
  # 4. ìŠ¬ë™ ì•Œë¦¼
  notify:
    needs: [validate, test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ìŠ¬ë™ ì•Œë¦¼ ì „ì†¡
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ğŸ® íŒŒì´í”„ë¼ì¸ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'âœ…' || 'âŒ' }} ê²Œì„ íŒŒì´í”„ë¼ì¸ CI/CD"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*ì»¤ë°‹:*\n${{ github.sha }}"}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
